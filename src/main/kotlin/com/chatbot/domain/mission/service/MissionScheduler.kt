package com.chatbot.domain.mission.service

import com.chatbot.domain.mission.entity.MissionEntity
import com.chatbot.domain.mission.repository.MissionRepository
import com.fasterxml.jackson.databind.ObjectMapper
import jakarta.transaction.Transactional
import org.springframework.ai.chat.messages.AssistantMessage
import org.springframework.ai.openai.OpenAiChatClient
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.stereotype.Component


@Component
class MissionScheduler (
    private val chatClient: OpenAiChatClient,
    private val missionRepository: MissionRepository,
    private val objectMapper: ObjectMapper
) {
    @Scheduled(cron = "0 0 0 * * *")
    @Transactional
    fun createMissions(){
        missionRepository.deleteAll();

        val initialPrompt = """
        ë„ˆëŠ” ì¶”ì²œ ë¯¸ì…˜ì„ ì•Œë ¤ì£¼ëŠ” aiì•¼.

        ìš°ë¦¬ ì„œë¹„ìŠ¤ëŠ” ëŒ€ì¶© 
        ""${'"'}
        Chill ë¼ì´í”„ íŠ¸ëž˜ì»¤ (Chill Life Tracker) ê¸°íšì•ˆ

        ì„œë¹„ìŠ¤ ê°œìš”

        â€œChill ë¼ì´í”„ íŠ¸ëž˜ì»¤â€ëŠ” ì‚¬ìš©ìžê°€ ìžì‹ ì˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° ì–¼ë§ˆë‚˜ ì—¬ìœ ë¡­ê³  í‰ì˜¨í•˜ê²Œ ë³´ëƒˆëŠ”ì§€ë¥¼ ê¸°ë¡í•˜ê³ , ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ëŠ” ìŠµê´€ì„ ë§Œë“¤ì–´ì£¼ëŠ” ê°ì • ê¸°ë¡ & ížë§ ë„ìš°ë¯¸ ì•±ìž…ë‹ˆë‹¤.
        ëª…ìƒ, ížë§ ì‚¬ìš´ë“œ, ìž‘ì€ ë¯¸ì…˜ ë“±ì„ ì œê³µí•˜ì—¬ ë” ì°¨ë¶„í•˜ê³  ê· í˜• ìž¡ížŒ ì‚¶ì„ ìœ ë„í•©ë‹ˆë‹¤.

        ì£¼ìš” ê¸°ëŠ¥

        â‘  ì¼ì¼ Chill ì§€ìˆ˜ ê¸°ë¡
            â€¢    â€œì˜¤ëŠ˜ ì–¼ë§ˆë‚˜ chillí–ˆë‚˜ìš”?â€ ì§ˆë¬¸ì— ë”°ë¼ ê°ì • ë° ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜ë¥¼ ê¸°ë¡
            â€¢    5ë‹¨ê³„ ì„ íƒ: ðŸ”¥ ë§¤ìš° ë°”ë¹´ìŒ â†’ ðŸ˜ í‰ë²”í–ˆìŒ â†’ ðŸ§˜ ì™„ì „ ì—¬ìœ ë¡œì› ìŒ
            â€¢    ì¶”ê°€ì ìœ¼ë¡œ ê°ì • ìƒíƒœ(ê¸°ì¨, í”¼ê³¤í•¨, ìŠ¤íŠ¸ë ˆìŠ¤ ë“±) ìž…ë ¥ ê°€ëŠ¥
            â€¢    í•˜ë£¨ì˜ ì£¼ìš” ì´ë²¤íŠ¸ë¥¼ ê°„ë‹¨í•œ íƒœê·¸ë¡œ ì¶”ê°€
            â€¢    ì˜ˆ: #ì»¤í”¼íƒ€ìž„ #ì‚°ì±… #ì—…ë¬´í­íƒ„ #ì¹œêµ¬ì™€ ìˆ˜ë‹¤

        â‘¡ Chill ìŠµê´€ & ë¯¸ì…˜
            â€¢    ì‚¬ìš©ìžê°€ ë” ì—¬ìœ ë¡œìš´ í•˜ë£¨ë¥¼ ë³´ë‚´ë„ë¡ ë•ëŠ” ê°„ë‹¨í•œ ë¯¸ì…˜ ì œê³µ
            â€¢    ì˜ˆ: â€œì˜¤ëŠ˜ 5ë¶„ ë™ì•ˆ í•˜ëŠ˜ì„ ë°”ë¼ë³´ì„¸ìš” ðŸŒ¤ï¸â€
            â€¢    â€œë¬¼ í•œ ìž” ë§ˆì‹œê³  ì‹¬í˜¸í¡ 3ë²ˆ í•´ë³´ê¸°â€
            â€¢    â€œë””ì§€í„¸ ë””í†¡ìŠ¤ 30ë¶„ ë„ì „í•˜ê¸°â€
            â€¢    ì‚¬ìš©ìžê°€ ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ë©´ ì¹  í¬ì¸íŠ¸(CHILL POINT) ì ë¦½

        â‘¢ ê°ì • ë¶„ì„ & ížë§ ì¶”ì²œ
            â€¢    ì‚¬ìš©ìžì˜ ê°ì • ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ë§žì¶¤í˜• ížë§ ì½˜í…ì¸  ì¶”ì²œ
            â€¢    ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ë†’ì„ ê²½ìš°: â€œì˜¤ëŠ˜ì€ ì´ëŸ° ëª…ìƒ ìŒì•…ì„ ë“¤ì–´ë³´ì„¸ìš” ðŸŽµâ€
            â€¢    í‰ì˜¨í•œ ë‚ : â€œì´ëŸ° ì—¬ìœ ë¡œìš´ ë…ì„œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤ ðŸ“–â€
            â€¢    í•œ ë‹¬ ë™ì•ˆ ê°€ìž¥ chillí–ˆë˜ ë‚ , ê°€ìž¥ ìŠ¤íŠ¸ë ˆìŠ¤ ë§Žì•˜ë˜ ë‚  ë“±ì„ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ ì œê³µ

        â‘£ Chill ë‹¤ì´ì–´ë¦¬ & íƒ€ìž„ë¼ì¸
            â€¢    ì‚¬ìš©ìžê°€ ê¸°ë¡í•œ í•˜ë£¨ë¥¼ ìžë™ìœ¼ë¡œ ë‹¤ì´ì–´ë¦¬ í˜•íƒœë¡œ ì •ë¦¬
            â€¢    â€œì´ë‚ ì€ ì´ëŸ° ê°ì •ì„ ëŠê¼ˆì–´ìš”!â€
            â€¢    ê°ì • ê·¸ëž˜í”„ë¥¼ í†µí•´ ë‚´ ê°ì • ë³€í™” ì¶”ì  ê°€ëŠ¥
            â€¢    ì§€ë‚œì£¼ì™€ ë¹„êµí•˜ì—¬ ë³€í™” ë¶„ì„

        â‘¤ ížë§ ì½˜í…ì¸  & ASMR ì§€ì›
            â€¢    ì‚¬ìš©ìž ìƒíƒœì— ë”°ë¼ ë§žì¶¤í˜• ížë§ ì½˜í…ì¸  ì œê³µ
            â€¢    ìžì—° ì†Œë¦¬(ë°”ëžŒ, íŒŒë„, ìƒˆì†Œë¦¬ ë“±)
            â€¢    ASMR ì˜¤ë””ì˜¤(ì±… ì½ëŠ” ì†Œë¦¬, ì°¨ ë“ì´ëŠ” ì†Œë¦¬)
            â€¢    ì‹¬í˜¸í¡ ê°€ì´ë“œ, ëª…ìƒ ìŒì„± ì œê³µ

        ë³´ìƒ ì‹œìŠ¤í…œ & ì»¤ë®¤ë‹ˆí‹° ìš”ì†Œ
         â€¢    Chill Point(ì¹  í¬ì¸íŠ¸) ì‹œìŠ¤í…œ
         â€¢    ë§¤ì¼ ê¸°ë¡ì„ ë‚¨ê¸°ê±°ë‚˜ ë¯¸ì…˜ì„ ìˆ˜í–‰í•˜ë©´ í¬ì¸íŠ¸ ì ë¦½
         â€¢    í¬ì¸íŠ¸ë¡œ ížë§ ì‚¬ìš´ë“œ, í…Œë§ˆ, ì•„ì´ì½˜ ë“± ìž ê¸ˆ í•´ì œ ê°€ëŠ¥
         â€¢    ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ (ì„ íƒì‚¬í•­)
         â€¢    â€œì˜¤ëŠ˜ì˜ chill ìˆœê°„â€ì„ ê³µìœ í•˜ëŠ” ì»¤ë®¤ë‹ˆí‹° í”¼ë“œ
         â€¢    ë‹¤ë¥¸ ì‚¬ìš©ìžì˜ ížë§ íŒ ì°¸ê³  ê°€ëŠ¥

        ìœ ì € ì‹œë‚˜ë¦¬ì˜¤

        âœ” ì•„ì¹¨
            â€¢    â€œì˜¤ëŠ˜ì˜ ê°ì • ìƒíƒœë¥¼ ìž…ë ¥í•˜ì„¸ìš”â€
            â€¢    â€œì˜¤ëŠ˜ì˜ ì¶”ì²œ ë¯¸ì…˜: 5ë¶„ ë™ì•ˆ ì°½ë°–ì„ ë°”ë¼ë³´ê¸° ðŸŒ¿â€

        âœ” ì ì‹¬ í›„
            â€¢    â€œì§€ê¸ˆê¹Œì§€ì˜ ê¸°ë¶„ì€ ì–´ë•Œìš”?â€ ì•Œë¦¼
            â€¢    ì ì‹¬ í›„ ê°€ë²¼ìš´ ìŠ¤íŠ¸ë ˆì¹­ ì¶”ì²œ

        âœ” ì €ë…
            â€¢    â€œì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ëŒì•„ë³´ì„¸ìš”â€
            â€¢    ê°ì • ê·¸ëž˜í”„ ë° ë§žì¶¤í˜• ížë§ ì½˜í…ì¸  ì¶”ì²œ

        ê¸°ìˆ  ìŠ¤íƒ & ê°œë°œ ë°©í–¥
         â€¢    í”„ë¡ íŠ¸ì—”ë“œ: Vue.js + TailwindCSS
         â€¢    ë°±ì—”ë“œ: Node.js + Express
         â€¢    ë°ì´í„°ë² ì´ìŠ¤: MongoDB ë˜ëŠ” Firebase
         â€¢    ê¸°íƒ€: PWA ì§€ì›í•˜ì—¬ ì›¹/ì•± ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥

        ê¸°ëŒ€ íš¨ê³¼

        âœ… ì‚¬ìš©ìžê°€ í•˜ë£¨ë¥¼ ëŒì•„ë³´ë©° ê°ì • ì¸ì‹ ëŠ¥ë ¥ í–¥ìƒ
        âœ… ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ê³ , ë” ì°¨ë¶„í•œ ì¼ìƒ ìœ ì§€ ê°€ëŠ¥
        âœ… ëª…ìƒ/ížë§ ì½˜í…ì¸ ë¥¼ í†µí•´ ì •ì‹  ê±´ê°• ê´€ë¦¬ ë„ì›€
        ""${'"'}

        ë„ˆëŠ” ì¶”ì²œ ë¯¸ì…˜ì„ 4ê°€ì§€ ë§Œë“¤ì–´.
        ë¯¸ì…˜ì€ íƒ€ì´ë¨¸ë¡œ í• ìˆ˜ìžˆë„ë¡ ì‹œê°„ì„ ì‚¬ìš©í•˜ëŠ” ë¯¸ì…˜ìœ¼ë¡œ í•´ì¤˜
        
        ì¶”ì²œë¯¸ì…˜, íƒ€ì´ë¨¸ ì‹œê°„, ë¯¸ì…˜ì˜ ê°•ë„ì— ë”°ë¼ 10ì—ì„œ 30 ì‚¬ì´ì˜ ìˆ«ìžì¤‘ í•˜ë‚˜ë¥¼ jsoní˜•íƒœë¡œ ë°˜í™˜í•´ì¤˜ 
        
        """.trimIndent()

        val prompt = mutableListOf(
            AssistantMessage(initialPrompt)
        )
        val response = chatClient.call(prompt.toString())

        val rootNode = objectMapper.readTree(response)
        val missions = rootNode["missions"]

        missions.forEach { node ->
            val mission = node["mission"].asText()
            val timer = node["timer"].asInt()
            val intensity = node["intensity"].asInt()

            val missionEntity = MissionEntity(
                mission = mission,
                timer = timer,
                intensity = intensity,
                isComplete = false
            )
            missionRepository.save(missionEntity)
        }
    }
}